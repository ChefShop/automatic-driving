Settings                    = {}
Settings.UseAllowedVehicles = true

Controls                    = {}
Controls.Toggle             = 159
Controls.ObeyLaws           = 165
Controls.IncreaseSpeed      = 71
Controls.DecreaseSpeed      = 72
Controls.StopVehicle        = 76
Controls.Cancel1            = 75
Controls.Cancel2            = 63
Controls.Cancel3            = 64

Strings = {}
Strings.SelfDrivingOff      = "~y~Conduite Auto. ~r~Off"
Strings.SelfDrivingOn       = "~y~Conduite Auto. ~g~On"
Strings.EnableSelfDriving   = "Activer La Conduite Auto"
Strings.SpeedPlus           = "Vitesse +"
Strings.SpeedMinus          = "Vitesse -"
Strings.Resume              = "Reprendre"
Strings.Stop                = "Stoper"
Strings.ObeyTrafficLaws     = "Suivre Le Trafic"
Strings.IgnoreTrafficLaws   = "Ignorer Le Trafic"
Strings.Disable             = "Désactiver"
Strings.HelpNotification1   = "~y~Définissez un point sur le GPS, puis réessayez."
Strings.MPH                 = "KM"

AllowedVehicles = {
  "MODELS",
  "TESLAX",
  "ADDER",
  "AIRBUS",
  "AIRTUG",
  "AKULA",
  "AKUMA",
  "ALPHA",
  "ALPHAZ1",
  "AMBULANCE",
  "ANNIHILATOR",
  "APC",
  "ARDENT",
  "ARMYTANKER",
  "ARMYTRAILER",
  "ARMYTRAILER2",
  "ASEA",
  "ASEA2",
  "ASTEROPE",
  "AUTARCH",
  "AVARUS",
  "AVENGER",
  "AVENGER2",
  "BAGGER",
  "BALETRAILER",
  "BALLER",
  "BALLER2",
  "BALLER3",
  "BALLER4",
  "BALLER5",
  "BALLER6",
  "BANSHEE",
  "BANSHEE2",
  "BARRACKS",
  "BARRACKS2",
  "BARRACKS2",
  "BARRACKS3",
  "BARRAGE",
  "BATI",
  "BATI2",
  "BENSON",
  "BESRA",
  "BESTIAGTS",
  "BF400",
  "BFINJECTION",
  "BIFF",
  "BIFTA",
  "BISON",
  "BISON2",
  "BISON3",
  "BJXL",
  "BLADE",
  "BLAZER",
  "BLAZER2",
  "BLAZER3",
  "BLAZER4",
  "BLAZER5",
  "BLIMP",
  "BLIMP2",
  "BLIMP3",
  "BLISTA",
  "BLISTA2",
  "BLISTA3",
  "BMX",
  "BOATTRAILER",
  "BOBCATXL",
  "BODHI2",
  "BOMBUSHKA",
  "BOXVILLE",
  "BOXVILLE2",
  "BOXVILLE3",
  "BOXVILLE4",
  "BOXVILLE5",
  "BRAWLER",
  "BRICKADE",
  "BRIOSO",
  "BRUISER",
  "BRUISER2",
  "BRUISER3",
  "BRUTUS",
  "BRUTUS2",
  "BRUTUS3",
  "BTYPE",
  "BTYPE2",
  "BTYPE3",
  "BUCCANEER",
  "BUCCANEER2",
  "BUFFALO",
  "BUFFALO2",
  "BUFFALO3",
  "BULLDOZER",
  "BULLET",
  "BURRITO",
  "BURRITO2",
  "BURRITO3",
  "BURRITO4",
  "BURRITO5",
  "BUS",
  "BUZZARD",
  "BUZZARD2",
  "CABLECAR",
  "CADDY",
  "CADDY2",
  "CADDY3",
  "CAMPER",
  "CARACARA",
  "CARBONIZZARE",
  "CARBONRS",
  "CARGOBOB",
  "CARGOBOB2",
  "CARGOBOB3",
  "CARGOBOB4",
  "CARGOPLANE",
  "CASCO",
  "CAVALCADE",
  "CAVALCADE2",
  "CEREBRUS",
  "CEREBRUS2",
  "CEREBRUS3",
  "CHEBUREK",
  "CHEETAH",
  "CHEETAH2",
  "CHERNOBOG",
  "CHIMERA",
  "CHINO",
  "CHINO2",
  "CLIFFHANGER",
  "CLIQUE",
  "COACH",
  "COG55",
  "COG552",
  "COGCABRIO",
  "COGNOSCENTI",
  "COGNOSCENTI2",
  "COMET2",
  "COMET3",
  "COMET4",
  "COMET5",
  "CONTENDER",
  "COQUETTE",
  "COQUETTE2",
  "COQUETTE3",
  "CRUISER",
  "CRUSADER",
  "CUBAN800",
  "CUTTER",
  "CYCLONE",
  "DAEMON",
  "DAEMON2",
  "DEATHBIKE",
  "DEATHBIKE2",
  "DEATHBIKE3",
  "DEFILER",
  "DELUXO",
  "DEVESTE",
  "DEVIANT",
  "DIABLOUS",
  "DIABLOUS2",
  "DILETTANTE",
  "DILETTANTE2",
  "DINGHY",
  "DINGHY",
  "DINGHY2",
  "DINGHY3",
  "DINGHY4",
  "DLOADER",
  "DOCKTRAILER",
  "DOCKTUG",
  "DODO",
  "DOMINATOR",
  "DOMINATOR2",
  "DOMINATOR3",
  "DOMINATOR4",
  "DOMINATOR5",
  "DOMINATOR6",
  "DOUBLE",
  "DUBSTA",
  "DUBSTA2",
  "DUBSTA3",
  "DUKES",
  "DUKES2",
  "DUMP",
  "DUNE",
  "DUNE2",
  "DUNE3",
  "DUNE4",
  "DUNE5",
  "DUSTER",
  "ELEGY",
  "ELEGY2",
  "ELLIE",
  "EMPEROR",
  "EMPEROR2",
  "EMPEROR3",
  "ENDURO",
  "ENTITY2",
  "ENTITYXF",
  "ESSKEY",
  "EXEMPLAR",
  "F620",
  "FACTION",
  "FACTION2",
  "FACTION3",
  "FAGALOA",
  "FAGGIO",
  "FAGGIO2",
  "FAGGIO3",
  "FBI",
  "FBI2",
  "FCR",
  "FCR2",
  "FELON",
  "FELON2",
  "FELTZER2",
  "FELTZER3",
  "FIRETRUK",
  "FIXTER",
  "FLASHGT",
  "FLATBED",
  "FMJ",
  "FORKLIFT",
  "FQ2",
  "FREECRAWLER",
  "FREIGHT",
  "FREIGHTCAR",
  "FREIGHTCONT1",
  "FREIGHTCONT2",
  "FREIGHTGRAIN",
  "FREIGHTTRAILER",
  "FROGGER",
  "FROGGER2",
  "FUGITIVE",
  "FUROREGT",
  "FUSILADE",
  "FUTO",
  "GARGOYLE",
  "GAUNTLET",
  "GAUNTLET2",
  "GB200",
  "GBURRITO",
  "GBURRITO2",
  "GLENDALE",
  "GP1",
  "GRAINTRAILER",
  "GRANGER",
  "GRESLEY",
  "GT500",
  "GUARDIAN",
  "HABANERO",
  "HAKUCHOU",
  "HAKUCHOU2",
  "HALFTRACK",
  "HANDLER",
  "HAULER",
  "HAULER2",
  "HAVOK",
  "HERMES",
  "HEXER",
  "HOTKNIFE",
  "HOTRING",
  "HOWARD",
  "HUNTER",
  "HUNTLEY",
  "HUSTLER",
  "HYDRA",
  "IMPALER",
  "IMPALER2",
  "IMPALER3",
  "IMPALER4",
  "IMPERATOR",
  "IMPERATOR2",
  "IMPERATOR3",
  "INFERNUS",
  "INFERNUS2",
  "INGOT",
  "INNOVATION",
  "INSURGENT",
  "INSURGENT2",
  "INSURGENT3",
  "INTRUDER",
  "ISSI2",
  "ISSI3",
  "ISSI4",
  "ISSI5",
  "ISSI6",
  "ITALIGTB",
  "ITALIGTB2",
  "ITALIGTO",
  "JACKAL",
  "JB700",
  "JESTER",
  "JESTER2",
  "JESTER3",
  "JET",
  "JETMAX",
  "JOURNEY",
  "KALAHARI",
  "KAMACHO",
  "KHAMELION",
  "KHANJALI",
  "KURUMA",
  "KURUMA2",
  "LANDSTALKER",
  "LAZER",
  "LE7B",
  "LECTRO",
  "LGUARD",
  "LIMO2",
  "LURCHER",
  "LUXOR",
  "LUXOR2",
  "LYNX",
  "MAMBA",
  "MAMMATUS",
  "MANANA",
  "MANCHEZ",
  "MARQUIS",
  "MARSHALL",
  "MASSACRO",
  "MASSACRO2",
  "MAVERICK",
  "MENACER",
  "MENACER",
  "MESA",
  "MESA2",
  "MESA3",
  "METROTRAIN",
  "MICHELLI",
  "MICROLIGHT",
  "MILJET",
  "MINIVAN",
  "MINIVAN2",
  "MIXER",
  "MIXER2",
  "MOGUL",
  "MOLOTOK",
  "MONROE",
  "MONSTER",
  "MONSTER3",
  "MONSTER4",
  "MONSTER5",
  "MOONBEAM",
  "MOONBEAM2",
  "MOWER",
  "MULE",
  "MULE2",
  "MULE3",
  "MULE4",
  "NEMESIS",
  "NEON",
  "NERO",
  "NERO2",
  "NIGHTBLADE",
  "NIGHTSHADE",
  "NIGHTSHARK",
  "NIMBUS",
  "NINEF",
  "NINEF2",
  "NOKOTA",
  "OMNIS",
  "OPPRESSOR",
  "OPPRESSOR2",
  "ORACLE",
  "ORACLE2",
  "OSIRIS",
  "PACKER",
  "PANTO",
  "PARADISE",
  "PARIAH",
  "PATRIOT",
  "PATRIOT2",
  "PBUS",
  "PBUS2",
  "PCJ",
  "PENETRATOR",
  "PENUMBRA",
  "PEYOTE",
  "PFISTER811",
  "PHANTOM",
  "PHANTOM2",
  "PHANTOM3",
  "PHOENIX",
  "PICADOR",
  "PIGALLE",
  "POLICE",
  "POLICE2",
  "POLICE3",
  "POLICE4",
  "POLICEB",
  "POLICEOLD1",
  "POLICEOLD2",
  "POLICET",
  "POLMAV",
  "PONY",
  "PONY2",
  "POUNDER",
  "POUNDER2",
  "PRAIRIE",
  "PRANGER",
  "PREDATOR",
  "PREMIER",
  "PRIMO",
  "PRIMO2",
  "PROPTRAILER",
  "PROTOTIPO",
  "PYRO",
  "RADI",
  "RAIDEN",
  "RAKETRAILER",
  "RALLYTRUCK",
  "RANCHERXL",
  "RANCHERXL2",
  "RAPIDGT",
  "RAPIDGT2",
  "RAPIDGT3",
  "RAPTOR",
  "RATBIKE",
  "RATLOADER",
  "RATLOADER2",
  "RCBANDITO",
  "REAPER",
  "REBEL",
  "REBEL2",
  "REGINA",
  "RENTALBUS",
  "RETINUE",
  "REVOLTER",
  "RHAPSODY",
  "RHINO",
  "RIATA",
  "RIOT",
  "RIOT2",
  "RIPLEY",
  "ROCOTO",
  "ROGUE",
  "ROMERO",
  "RUBBLE",
  "RUFFIAN",
  "RUINER",
  "RUINER2",
  "RUINER3",
  "RUMPO",
  "RUMPO2",
  "RUMPO3",
  "RUSTON",
  "SABREGT",
  "SABREGT2",
  "SADLER",
  "SADLER2",
  "SANCHEZ",
  "SANCHEZ2",
  "SANCTUS",
  "SANDKING",
  "SANDKING2",
  "SAVAGE",
  "SAVESTRA",
  "SC1",
  "SCARAB",
  "SCARAB2",
  "SCARAB3",
  "SCHAFTER2",
  "SCHAFTER3",
  "SCHAFTER4",
  "SCHAFTER5",
  "SCHAFTER6",
  "SCHLAGEN",
  "SCHWARZER",
  "SCORCHER",
  "SCRAMJET",
  "SCRAP",
  "SEABREEZE",
  "SEASHARK",
  "SEASHARK2",
  "SEASHARK3",
  "SEASPARROW",
  "SEMINOLE",
  "SENTINEL",
  "SENTINEL2",
  "SENTINEL3",
  "SERRANO",
  "SEVEN70",
  "SHAMAL",
  "SHEAVA",
  "SHERIFF",
  "SHERIFF2",
  "SHOTARO",
  "SKYLIFT",
  "SLAMVAN",
  "SLAMVAN2",
  "SLAMVAN3",
  "SLAMVAN4",
  "SLAMVAN5",
  "SLAMVAN6",
  "SOVEREIGN",
  "SPECTER",
  "SPECTER2",
  "SPEEDER",
  "SPEEDER2",
  "SPEEDO",
  "SPEEDO2",
  "SPEEDO4",
  "SQUALO",
  "STAFFORD",
  "STALION",
  "STALION2",
  "STANIER",
  "STARLING",
  "STINGER",
  "STINGERGT",
  "STOCKADE",
  "STOCKADE3",
  "STRATUM",
  "STREITER",
  "STRETCH",
  "STRIKEFORCE",
  "STROMBERG",
  "STUNT",
  "SUBMERSIBLE",
  "SUBMERSIBLE2",
  "SULTAN",
  "SULTANRS",
  "SUNTRAP",
  "SUPERD",
  "SUPERVOLITO",
  "SUPERVOLITO2",
  "SURANO",
  "SURFER",
  "SURFER2",
  "SURGE",
  "SWIFT",
  "SWIFT2",
  "SWINGER",
  "T20",
  "TACO",
  "TAILGATER",
  "TAIPAN",
  "TAMPA",
  "TAMPA2",
  "TAMPA3",
  "TANKER",
  "TANKER2",
  "TANKERCAR",
  "TAXI",
  "TECHNICAL",
  "TECHNICAL2",
  "TECHNICAL3",
  "TEMPESTA",
  "TERBYTE",
  "TEZERACT",
  "THRUST",
  "THRUSTER",
  "TIPTRUCK",
  "TIPTRUCK2",
  "TITAN",
  "TORERO",
  "TORNADO",
  "TORNADO2",
  "TORNADO3",
  "TORNADO4",
  "TORNADO5",
  "TORNADO6",
  "TORO",
  "TORO2",
  "TOROS",
  "TOURBUS",
  "TOWTRUCK",
  "TOWTRUCK2",
  "TR2",
  "TR3",
  "TR4",
  "TRACTOR",
  "TRACTOR2",
  "TRACTOR3",
  "TRAILERLARGE",
  "TRAILERLOGS",
  "TRAILERS",
  "TRAILERS2",
  "TRAILERS3",
  "TRAILERS4",
  "TRAILERSMALL",
  "TRAILERSMALL2",
  "TRASH",
  "TRASH2",
  "TRFLAT",
  "TRIBIKE",
  "TRIBIKE2",
  "TRIBIKE3",
  "TROPHYTRUCK",
  "TROPHYTRUCK2",
  "TROPIC",
  "TROPIC2",
  "TROPOS",
  "TUG",
  "TULA",
  "TULIP",
  "TURISMO2",
  "TURISMOR",
  "TVTRAILER",
  "TYRANT",
  "TYRUS",
  "UTILLITRUCK",
  "UTILLITRUCK2",
  "UTILLITRUCK3",
  "VACCA",
  "VADER",
  "VALKYRIE",
  "VALKYRIE2",
  "VAMOS",
  "VELUM",
  "VELUM2",
  "VERLIERER2",
  "VESTRA",
  "VIGERO",
  "VIGILANTE",
  "VINDICATOR",
  "VIRGO",
  "VIRGO2",
  "VIRGO3",
  "VISERIS",
  "VISERIS",
  "VISIONE",
  "VOLATOL",
  "VOLATUS",
  "VOLTIC",
  "VOLTIC2",
  "VOODOO",
  "VOODOO2",
  "VORTEX",
  "Vagner",
  "WARRENER",
  "WASHINGTON",
  "WASTELANDER",
  "WINDSOR",
  "WINDSOR2",
  "WOLFSBANE",
  "XA21",
  "XLS",
  "XLS2",
  "YOSEMITE",
  "YOUGA",
  "YOUGA2",
  "Z190",
  "ZENTORNO",
  "ZION",
  "ZION2",
  "ZOMBIEA",
  "ZOMBIEB",
  "ZR380",
  "ZR3802",
  "ZR3803",
  "ZTYPE",
}

for k,v in pairs(AllowedVehicles)
do
    AllowedVehicles[GetHashKey(v)] = v
end

function GetScaleformInit(size)

  size = ( size and tonumber(size or 200) or 200 )

  local scaleform = RequestScaleformMovie("instructional_buttons")
  while not HasScaleformMovieLoaded(scaleform) do Citizen.Wait(0) end

  PushScaleformMovieFunction(scaleform, "CLEAR_ALL")
  PopScaleformMovieFunctionVoid()

  PushScaleformMovieFunction(scaleform, "SET_CLEAR_SPACE")
  PushScaleformMovieFunctionParameterInt(size)
  PopScaleformMovieFunctionVoid()

  return scaleform

end


function GetScaleformAddData(scaleform,...)

  if select("#",...) < 1 then return scaleform; end;

  local i       = 1
  local v       = select(i,...)
  local slot    = -1
  local newSlot = true

  while v
  do
      if      type(v) == "number"
      then
              if  newSlot
              then
                  slot = slot + 1
                  PushScaleformMovieFunction(scaleform, "SET_DATA_SLOT")
                  PushScaleformMovieFunctionParameterInt(slot)
                  newSlot = false
              end
              InstructionButton(GetControlInstructionalButton(0, v, true))

      elseif  type(v) == "string"
      then
              InstructionButtonMessage(v)
              PopScaleformMovieFunctionVoid()
              newSlot = true
      end
      i = i + 1
      v = select(i,...)
  end

  PushScaleformMovieFunction(scaleform, "DRAW_INSTRUCTIONAL_BUTTONS")
  PopScaleformMovieFunctionVoid()

  PushScaleformMovieFunction(scaleform, "SET_BACKGROUND_COLOUR")
  PushScaleformMovieFunctionParameterInt(0)
  PushScaleformMovieFunctionParameterInt(0)
  PushScaleformMovieFunctionParameterInt(0)
  PushScaleformMovieFunctionParameterInt(80)
  PopScaleformMovieFunctionVoid()

  return scaleform
end



function GetInstructionalScaleform(...)
  local scaleform = GetScaleformInit()
  scaleform = GetScaleformAddData(scaleform,...)
  return scaleform
end


function InstructionButton(button)
  N_0xe83a3e3557a56640(button)
end

function InstructionButtonMessage(text)
  BeginTextCommandScaleformString("STRING")
  AddTextComponentScaleform(text)
  EndTextCommandScaleformString()
end


--[[
jesus.scaleform = GetScaleform()
while true do 
    DrawScaleformMovieFullscreen(jesus.scaleform, 255, 255, 255, 255, 0)
    Wait(0)
end
--]]

--------------------------------------------------------------------------------

local ds = 
  {
    ["Stop before vehicles"]   =         1,
    ["Stop before peds"]       =         2,
    ["Avoid vehicles"]         =         4,
    ["Avoid empty vehicles"]   =         8,
    ["Avoid peds"]             =        16,
    ["Avoid objects"]          =        32,
    ["Stop at traffic lights"] =       128,
    ["Use blinkers"]           =       256,
    ["Allow going wrong way"]  =       512,
    ["Go in reverse"]          =      1024,
    ["Take shortest path"]     =    262144,
    ["Ignore roads"]           =   4194304, -- Only works < 200 meters
    ["Ignore all pathing"]     =  16777216,
    ["Avoid highways"]         = 536870912,
  }


SelfDriving = {

  PreferredDrivingStyleFar        = 0 +ds["Avoid peds"]       +ds["Avoid vehicles"]       +ds["Use blinkers"]     --[[+ds["Allow going wrong way"]--]] +ds["Avoid empty vehicles"]  +ds["Avoid objects"],
  PreferredDrivingStyleFarObey    = 0 +ds["Stop before peds"] +ds["Stop before vehicles"] +ds["Use blinkers"]     --[[+ds["Allow going wrong way"--]]  +ds["Avoid empty vehicles"]  +ds["Avoid objects"]      +ds["Stop at traffic lights"],
  PreferredDrivingStyleNear       = 0 +ds["Avoid peds"]       +ds["Avoid vehicles"]       +ds["Use blinkers"]         +ds["Allow going wrong way"]     +ds["Avoid empty vehicles"]  +ds["Avoid objects"],
  PreferredDrivingStyleSafe       = 0 +ds["Stop before peds"] +ds["Stop before vehicles"] +ds["Use blinkers"]         +ds["Allow going wrong way"],  --+ds["Avoid empty vehicles"]  +ds["Avoid objects"]
  PreferredDrivingStyleOffRoad    = 0 +ds["Avoid peds"]       +ds["Avoid vehicles"]       +ds["Avoid empty vehicles"] +ds["Avoid objects"]             +ds["Allow going wrong way"] +ds["Ignore all pathing"] +ds["Take shortest path"],
  PreferredDrivingStyleDriver     = 0 +ds["Stop before peds"] +ds["Stop before vehicles"] +ds["Use blinkers"]         +ds["Allow going wrong way"]     +ds["Avoid empty vehicles"]  +ds["Avoid objects"],
  PreferredDrivingStyleBoats      = 0 +ds["Avoid peds"]       +ds["Avoid vehicles"]       +ds["Avoid empty vehicles"] +ds["Avoid objects"]             +ds["Allow going wrong way"] +ds["Avoid highways"]     +ds["Ignore roads"],
  PreferredDrivingStyleBoatsNear  = 0 +ds["Avoid peds"]       +ds["Avoid vehicles"]       +ds["Avoid empty vehicles"] +ds["Avoid objects"]             +ds["Allow going wrong way"] +ds["Avoid highways"]     +ds["Ignore roads"] +ds["Take shortest path"],

  Get2dDistance = function(v1,v2) return math.sqrt( (v1.x-v2.x)*(v1.x-v2.x) + (v1.y-v2.y)*(v1.y-v2.y) ) end,

-- BEGIN_TEXT_COMMAND_DISPLAY_HELP("STRING");  
-- ADD_TEXT_COMPONENT_SUBSTRING_PLAYER_NAME(text);  
-- END_TEXT_COMMAND_DISPLAY_HELP (0, 0, 1, -1);  

  HelpNotification =
    function(msg)
      AddTextEntry('helpNotification'..tostring(GetGameTimer()), msg)
      BeginTextCommandDisplayHelp('helpNotification'..tostring(GetGameTimer()))
      EndTextCommandDisplayHelp(0, false, true, -1)
    end,


  ShowNotification =
    function(msg)
      AddTextEntry('esxNotification'..tostring(GetGameTimer()), msg)
      SetNotificationTextEntry('esxNotification'..tostring(GetGameTimer()))
      DrawNotification(false, true)
    end,


  GetKeyPressed =
    function(key)
      key = tostring(key):upper()
      local keyid = NATIVE_KEYS[key]
      if not keyid then return false; end;
      return IsControlPressed(0,keyid) or IsDisabledControlPressed(0,keyid)
    end,


  GetKeyJustPressed =
    function(key)
      key = tostring(key):upper()
      local keyid = NATIVE_KEYS[key]
      if not keyid then return false; end;
      return IsControlJustPressed(0,keyid) or IsDisabledControlJustPressed(0,keyid)
    end,


  GetKeyJustReleased =
    function(key)
      key = tostring(key):upper()
      local keyid = NATIVE_KEYS[key]
      if not keyid then return false; end;
      return IsControlJustReleased(0,keyid) or IsDisabledControlJustReleased(0,keyid)
    end,


  GetPlayerWaypoint =
    function(self)
        local i                   = GetFirstBlipInfoId(8)
        local coords              = false
        if DoesBlipExist(i) and not coords
        then
            if  ( GetBlipInfoIdType(i) == 4 )
            then
                coords = GetBlipCoords(i)
                coords = vector3(coords.x,coords.y,self.elevation)
                self.wpIsSet = true
            end
        else
                self.wpIsSet = false
        end
        if  not coords
        then
            if    self.playerWaypointFound
            then  coords = self.playerWaypointCoords
            else
                  coords = ( self.ped and self.ped > 0 and GetEntityCoords(self.ped) or vector3(0,0,0) )
            end
        end
        self.coordsLast = self.coords
        self.coords = coords
        self.coordsChanged = ( self.coordsLast ~= self.coords )
    end,


}

SelfDriving.Keys          = {}
SelfDriving.Keys.toggle   = NATIVE_LOOKUP[Controls.Toggle]
SelfDriving.Keys.obeyLaws = NATIVE_LOOKUP[Controls.ObeyLaws]
SelfDriving.Keys.increase = NATIVE_LOOKUP[Controls.IncreaseSpeed]
SelfDriving.Keys.decrease = NATIVE_LOOKUP[Controls.DecreaseSpeed]
SelfDriving.Keys.stop     = NATIVE_LOOKUP[Controls.StopVehicle]
SelfDriving.Keys.cancel1  = NATIVE_LOOKUP[Controls.Cancel1]
SelfDriving.Keys.cancel2  = NATIVE_LOOKUP[Controls.Cancel2]
SelfDriving.Keys.cancel3  = NATIVE_LOOKUP[Controls.Cancel3]


SelfDriving.toggle        = false
SelfDriving.wpIsSet       = false
SelfDriving.ped           = -1
SelfDriving.veh           = -1
SelfDriving.driver        = -1
SelfDriving.speed         = 30.0 -- In MPH
SelfDriving.stopRange     = 10.0 -- In meters
SelfDriving.ability       = 1.0  -- 0.000 to 1.000 , anything else is ignored.
SelfDriving.elevation     = 300
SelfDriving.minSpeed      = 0
SelfDriving.maxSpeed      = 130
SelfDriving.stop          = false
SelfDriving.obeyLaws      = false


function SelfDriving:Toggle(toggle)

  if type(toggle) ~= "boolean" then toggle = not self.toggle; end

  self.toggle = toggle

  self.driveStyle = ( self.obeyLaws and self.PreferredDrivingStyleFarObey or self.PreferredDrivingStyleFar )

  if    toggle
  then
        local maxSpeed = ( ( GetVehicleEstimatedMaxSpeed(self.veh) or 0 ) * 2.23694 )
        if maxSpeed < 1 then maxSpeed = 100 else maxSpeed = ( maxSpeed + 9.9 ) - ( ( maxSpeed + 9.9 ) % 10 ); end
        self.maxSpeed = maxSpeed
        local curSpeed = math.max( math.min( self.stop and 0 or self.speed, self.maxSpeed ), self.minSpeed )
        SetDriverAbility( self.ped, self.ability )
        TaskVehicleDriveToCoordLongrange( self.ped,     self.veh, self.coords.x, self.coords.y, self.coords.z, curSpeed/2.23694,   self.driveStyle, self.stopRange )
        if not noNotify then self.HelpNotification(Strings.SelfDrivingOn.." ~s~"..tostring(math.floor(curSpeed)).." "..Strings.MPH.."\n~o~"..( self.obeyLaws and Strings.ObeyTrafficLaws or Strings.IgnoreTrafficLaws ) );  end;
  else
        ClearPedTasks(self.ped);
        self.driver = -1
        if not noNotify then self.HelpNotification(Strings.SelfDrivingOff); end;
  end

end



function SelfDriving:ThreadSelf()

  self.ped = GetPlayerPed(-1)

  self:GetPlayerWaypoint()

  if not self.ped or self.ped < 1 then return; end;

  self.veh     = GetVehiclePedIsIn(self.ped,false)
  
  if    self.veh > 0
  then  self.driver = GetPedInVehicleSeat(self.veh,-1); self.vehHash = GetEntityModel(self.veh)
  else  self.driver = -1; self.vehHash = 0
  end

  if  self.toggle
  and ( not self.veh or self.veh < 1 or not self.wpIsSet )
  then
      self:Toggle()
      return
  elseif ( not self.veh or self.veh < 1 )
  then
      return
  end

--self.vehClass = GetVehicleClass(self.veh) -- Commented out because not used yet.

  if      not self.driver
  or      self.driver ~= self.ped
  or      ( Settings.UseAllowedVehicles and not AllowedVehicles[self.vehHash] )
  then    return;
  end

  if      self.GetKeyJustPressed(self.Keys.toggle)
  then
          if  not self.wpIsSet
          then
              self.HelpNotification(Strings.HelpNotification1)
              return
          else
              self.stop = false; self:Toggle()
          end

  elseif  self.toggle and ( self.GetKeyJustPressed(self.Keys.cancel1) or self.GetKeyJustPressed(self.Keys.cancel2) or self.GetKeyJustPressed(self.Keys.cancel3) )
  then    self.stop = false; self:Toggle(false)

  elseif  not self.toggle
  then    return

  elseif  self.GetKeyJustPressed(self.Keys.increase)
  then
          
          if      self.stop
          then    self.stop = false; self:Toggle(true)
          elseif  self.speed >= 10 and self.speed <= 45
          then    self.speed = math.min( self.speed + 5, self.maxSpeed );   self:Toggle(true)
          else    self.speed = math.min( self.speed + 10, self.maxSpeed );  self:Toggle(true)
          end

  elseif  self.GetKeyJustPressed(self.Keys.decrease)
  then
          if      self.stop
          then    self.stop = false; self:Toggle(true)
          elseif  self.speed >= 15 and self.speed <= 50
          then    self.speed = math.max( self.speed -5, self.minSpeed );   self:Toggle(true)
          else    self.speed = math.max( self.speed -10, self.minSpeed );  self:Toggle(true)
          end

  elseif  self.GetKeyJustPressed(self.Keys.stop)
  then
          self.stop = not self.stop
          self:Toggle(true)

  elseif  self.GetKeyJustPressed(self.Keys.obeyLaws)
  then
          self.obeyLaws = not self.obeyLaws
          self:Toggle(true)

  elseif  self.coordsChanged
  then
          self:Toggle(true)
  end;

end


function SelfDriving.Thread()
  while true
  do
    Citizen.Wait(0)
    SelfDriving:ThreadSelf()
  end
end


Citizen.CreateThread( SelfDriving.Thread )


function SelfDriving.InstructionalButtonThread()
  return SelfDriving:InstructionalButtonThreadSelf()
end


function SelfDriving:GetSpecificButtonSet(index)

  if      index == 1
  then
          return
            GetInstructionalScaleform(
              NATIVE_KEYS[SelfDriving.Keys.toggle],     Strings.EnableSelfDriving
            )

  elseif  index == 2
  then
          return
              GetInstructionalScaleform(
                NATIVE_KEYS[SelfDriving.Keys.increase], Strings.SpeedPlus,
                NATIVE_KEYS[SelfDriving.Keys.decrease], Strings.SpeedMinus,
                NATIVE_KEYS[SelfDriving.Keys.stop],     Strings.Stop,
                NATIVE_KEYS[SelfDriving.Keys.obeyLaws], Strings.IgnoreTrafficLaws,
                NATIVE_KEYS[SelfDriving.Keys.toggle],   Strings.Disable
              )

  elseif  index == 3
  then
          return
              GetInstructionalScaleform(
                NATIVE_KEYS[SelfDriving.Keys.increase], Strings.SpeedPlus,
                NATIVE_KEYS[SelfDriving.Keys.decrease], Strings.SpeedMinus,
                NATIVE_KEYS[SelfDriving.Keys.stop],     Strings.Resume,
                NATIVE_KEYS[SelfDriving.Keys.obeyLaws], Strings.IgnoreTrafficLaws,
                NATIVE_KEYS[SelfDriving.Keys.toggle],   Strings.Disable
              )

  elseif  index == 4
  then
          return
              GetInstructionalScaleform(
                NATIVE_KEYS[SelfDriving.Keys.increase], Strings.SpeedPlus,
                NATIVE_KEYS[SelfDriving.Keys.decrease], Strings.SpeedMinus,
                NATIVE_KEYS[SelfDriving.Keys.stop],     Strings.Stop,
                NATIVE_KEYS[SelfDriving.Keys.obeyLaws], Strings.ObeyTrafficLaws,
                NATIVE_KEYS[SelfDriving.Keys.toggle],   Strings.Disable
              )

  elseif  index == 5
  then
          return
              GetInstructionalScaleform(
                NATIVE_KEYS[SelfDriving.Keys.increase], Strings.SpeedPlus,
                NATIVE_KEYS[SelfDriving.Keys.decrease], Strings.SpeedMinus,
                NATIVE_KEYS[SelfDriving.Keys.stop],     Strings.Resume,
                NATIVE_KEYS[SelfDriving.Keys.obeyLaws], Strings.ObeyTrafficLaws,
                NATIVE_KEYS[SelfDriving.Keys.toggle],   Strings.Disable
              )
  end

end


function SelfDriving:InstructionalButtonThreadSelf()

  if not NATIVE_KEYS then print("ERROR: main.lua 1106"); return; end;

  local index      = 0
  local previndex  = 0
  local scaleform  = false --  self:GetSpecificButtonSet(2)
  local helpShown  = false
  local helpFrames = 0

  while true do

    if  not self.toggle
    then
        if  self.driver == -1 --and index > 0
        then
            index     = 0;
            scaleform = false;
            helpShown = false;
        end
        if  self.driver > 0 and self.ped == self.driver
        then
            if      index ~= 1 and not helpShown
            then
                    index      = 1;
                    scaleform  = self:GetSpecificButtonSet(index);
                    helpShown  = true
                    helpFrames = 300

            elseif  helpFrames > 0
            then
                    helpFrames = helpFrames - 1

            elseif  helpFrames == 0
            then
                    scaleform = false
            end
        end

    elseif  self.toggle
    then
            if not self.stop and     self.obeyLaws and index ~= 2 then index = 2; scaleform = self:GetSpecificButtonSet(index); end;
            if     self.stop and     self.obeyLaws and index ~= 3 then index = 3; scaleform = self:GetSpecificButtonSet(index); end;
            if not self.stop and not self.obeyLaws and index ~= 4 then index = 4; scaleform = self:GetSpecificButtonSet(index); end;
            if     self.stop and not self.obeyLaws and index ~= 5 then index = 5; scaleform = self:GetSpecificButtonSet(index); end;


    end

    if scaleform then DrawScaleformMovieFullscreen(scaleform, 255, 255, 255, 255, 0); end;

    Wait(0)

  end

end

Citizen.CreateThread( SelfDriving.InstructionalButtonThread )
